# Comparing `tmp/karton_misp_pusher-1.0.0-py3-none-any.whl.zip` & `tmp/karton_misp_pusher-1.1.0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,14 +1,14 @@
-Zip file size: 6139 bytes, number of entries: 12
--rw-r--r--  2.0 unx      539 b- defN 21-May-19 11:12 karton_misp_pusher-1.0.0-nspkg.pth
--rw-r--r--  2.0 unx       62 b- defN 21-May-19 11:12 karton/misp_pusher/__init__.py
--rw-r--r--  2.0 unx       55 b- defN 21-May-19 11:12 karton/misp_pusher/__main__.py
--rw-r--r--  2.0 unx       22 b- defN 21-May-19 11:12 karton/misp_pusher/__version__.py
--rw-r--r--  2.0 unx     3744 b- defN 21-May-19 11:12 karton/misp_pusher/misp_pusher.py
--rw-r--r--  2.0 unx     1520 b- defN 21-May-19 11:12 karton_misp_pusher-1.0.0.dist-info/LICENSE
--rw-r--r--  2.0 unx     1726 b- defN 21-May-19 11:12 karton_misp_pusher-1.0.0.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 21-May-19 11:12 karton_misp_pusher-1.0.0.dist-info/WHEEL
--rw-r--r--  2.0 unx       75 b- defN 21-May-19 11:12 karton_misp_pusher-1.0.0.dist-info/entry_points.txt
--rw-r--r--  2.0 unx        7 b- defN 21-May-19 11:12 karton_misp_pusher-1.0.0.dist-info/namespace_packages.txt
--rw-r--r--  2.0 unx        7 b- defN 21-May-19 11:12 karton_misp_pusher-1.0.0.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     1095 b- defN 21-May-19 11:12 karton_misp_pusher-1.0.0.dist-info/RECORD
-12 files, 8944 bytes uncompressed, 4241 bytes compressed:  52.6%
+Zip file size: 7181 bytes, number of entries: 12
+-rw-r--r--  2.0 unx      539 b- defN 24-Apr-30 10:23 karton_misp_pusher-1.1.0-nspkg.pth
+-rw-r--r--  2.0 unx       62 b- defN 24-Apr-30 10:23 karton/misp_pusher/__init__.py
+-rw-r--r--  2.0 unx       55 b- defN 24-Apr-30 10:23 karton/misp_pusher/__main__.py
+-rw-r--r--  2.0 unx       22 b- defN 24-Apr-30 10:23 karton/misp_pusher/__version__.py
+-rw-r--r--  2.0 unx     6310 b- defN 24-Apr-30 10:23 karton/misp_pusher/misp_pusher.py
+-rw-r--r--  2.0 unx     1520 b- defN 24-Apr-30 10:23 karton_misp_pusher-1.1.0.dist-info/LICENSE
+-rw-r--r--  2.0 unx     2586 b- defN 24-Apr-30 10:23 karton_misp_pusher-1.1.0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 24-Apr-30 10:23 karton_misp_pusher-1.1.0.dist-info/WHEEL
+-rw-r--r--  2.0 unx       75 b- defN 24-Apr-30 10:23 karton_misp_pusher-1.1.0.dist-info/entry_points.txt
+-rw-r--r--  2.0 unx        7 b- defN 24-Apr-30 10:23 karton_misp_pusher-1.1.0.dist-info/namespace_packages.txt
+-rw-r--r--  2.0 unx        7 b- defN 24-Apr-30 10:23 karton_misp_pusher-1.1.0.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     1095 b- defN 24-Apr-30 10:23 karton_misp_pusher-1.1.0.dist-info/RECORD
+12 files, 12370 bytes uncompressed, 5283 bytes compressed:  57.3%
```

## zipnote {}

```diff
@@ -1,37 +1,37 @@
-Filename: karton_misp_pusher-1.0.0-nspkg.pth
+Filename: karton_misp_pusher-1.1.0-nspkg.pth
 Comment: 
 
 Filename: karton/misp_pusher/__init__.py
 Comment: 
 
 Filename: karton/misp_pusher/__main__.py
 Comment: 
 
 Filename: karton/misp_pusher/__version__.py
 Comment: 
 
 Filename: karton/misp_pusher/misp_pusher.py
 Comment: 
 
-Filename: karton_misp_pusher-1.0.0.dist-info/LICENSE
+Filename: karton_misp_pusher-1.1.0.dist-info/LICENSE
 Comment: 
 
-Filename: karton_misp_pusher-1.0.0.dist-info/METADATA
+Filename: karton_misp_pusher-1.1.0.dist-info/METADATA
 Comment: 
 
-Filename: karton_misp_pusher-1.0.0.dist-info/WHEEL
+Filename: karton_misp_pusher-1.1.0.dist-info/WHEEL
 Comment: 
 
-Filename: karton_misp_pusher-1.0.0.dist-info/entry_points.txt
+Filename: karton_misp_pusher-1.1.0.dist-info/entry_points.txt
 Comment: 
 
-Filename: karton_misp_pusher-1.0.0.dist-info/namespace_packages.txt
+Filename: karton_misp_pusher-1.1.0.dist-info/namespace_packages.txt
 Comment: 
 
-Filename: karton_misp_pusher-1.0.0.dist-info/top_level.txt
+Filename: karton_misp_pusher-1.1.0.dist-info/top_level.txt
 Comment: 
 
-Filename: karton_misp_pusher-1.0.0.dist-info/RECORD
+Filename: karton_misp_pusher-1.1.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## karton/misp_pusher/__version__.py

```diff
@@ -1 +1 @@
-__version__ = "1.0.0"
+__version__ = "1.1.0"
```

## karton/misp_pusher/misp_pusher.py

```diff
@@ -1,13 +1,26 @@
+import argparse
+import json
 from uuid import UUID, uuid5
 
 from karton.core import Config, Karton, Task
 from mwdb_iocextract import parse  # type: ignore
 from mwdblib.util import config_dhash  # type: ignore
-from pymisp import ExpandedPyMISP, MISPEvent
+from pymisp import MISPEvent, PyMISP
+from pymisp.mispevent import MISPGalaxyCluster
+
+
+def http_url(value: str) -> str:
+    """Ensure that provided value looks like a HTTP URL (https://sth),
+    and strip a trailing slash. The goal is to avoid confusion between
+    "url.com", "http://url.com", "http://url.com/", etc.
+    """
+    if not value.startswith("http"):
+        raise ValueError("URL should start with http[s]://")
+    return value.rstrip("/")
 
 
 class MispPusher(Karton):
     """
     Transforms configurations using mwdb-iocextract and pushes to a
     configured MISP instance.
     """
@@ -15,104 +28,155 @@
     identity = "karton.misp-pusher"
     filters = [{"type": "config"}]
 
     # Arbitrary root namespace for MISP UUIDs.
     # Event UUIDs are generated deterministically from a (root, cfg_hash) pair.
     CONFIG_NAMESPACE = UUID("dc232ceb-a523-41a1-98f4-8d3d52ec6eff")
 
-    def process(self, task: Task) -> None:  # type: ignore
+    def __init__(self, *args, **kwargs) -> None:
+        super().__init__(*args, **kwargs)
+
+        if not self.config.get("misp", "url"):
+            raise RuntimeError("Misp config section is missing the url parameter")
+
+        if not self.config.get("misp", "key"):
+            raise RuntimeError("Misp config section is missing the key parameter")
+
+        self.misp_url = http_url(self.config.get("misp", "url"))
+        self.misp_key = self.config.get("misp", "key")
+        self.misp_ssl = not self.config.getboolean("misp", "insecure", False)
+        self.misp_timeout = self.config.getint("misp", "timeout", 10)
+        self.tag_events = self.config.getboolean("misp", "tag_events", True)
+        self.misp_published = self.config.getboolean("misp", "published", False)
+
+        self.cluster_mapping = {}
+        if self.config.get("misp", "galaxy_clusters_mapping"):
+            with open(self.config.get("misp", "galaxy_clusters_mapping"), "r") as f:
+                self.cluster_mapping = json.load(f)
+                self.log.info(
+                    "Loaded MISP cluster mappings for %d families",
+                    len(self.cluster_mapping.keys()),
+                )
+
+    def process(self, task: Task) -> None:
         config = task.get_payload("config")
         family = task.headers["family"]
         dhash = config_dhash(config)
 
         # Parse the config using iocextract library
         iocs = parse(family, config)
 
         if not iocs:
             # Nothing actionable found - skip the config
             return
 
+        misp = PyMISP(
+            url=self.misp_url,
+            key=self.misp_key,
+            ssl=self.misp_ssl,
+            timeout=self.misp_timeout,
+        )
+
         # Upload structured data to MISP
         event = MISPEvent()
         event.uuid = str(uuid5(self.CONFIG_NAMESPACE, dhash))
-        event.add_tag(f"mwdb:family:{family}")
+
+        event.add_tag("mwdb:static")
+
+        if self.tag_events:
+            event.add_tag(f"mwdb:family:{family}")
+
+        if self.cluster_mapping:
+            if family not in self.cluster_mapping:
+                self.log.error(
+                    "Family name %s not present in MISP cluster mapping", family
+                )
+            else:
+                cluster_uuid = self.cluster_mapping[family]
+                if cluster_uuid is None:
+                    self.log.info(
+                        "Family %s ignored in cluster mapping, not reporting it", family
+                    )
+                    return
+
+                galaxy_cluster = misp.get_galaxy_cluster(cluster_uuid, pythonify=True)
+                if type(galaxy_cluster) is not MISPGalaxyCluster:
+                    raise Exception(
+                        f"Couldn't find galaxy cluster: {str(galaxy_cluster)}"
+                    )
+
+                self.log.info(
+                    "Adding tag %s for cluster relationship",
+                    galaxy_cluster.tag_name,  # type: ignore
+                )
+                event.add_tag(galaxy_cluster.tag_name)  # type: ignore
+
         event.info = f"Malware configuration ({family})"
 
-        if self.mwdb_url is not None:
-            event.add_attribute("link", f"{self.mwdb_url}/config/{dhash}")
+        mwdb_url = self.config.get("misp", "mwdb_url")
+
+        if mwdb_url is not None:
+            event.add_attribute("link", f"{mwdb_url}/config/{dhash}")
 
         for o in iocs.to_misp():
             event.add_object(o)
 
-        misp = ExpandedPyMISP(self.misp_url, self.misp_key, self.misp_verifycert)
-        misp.add_event(event)
+        event.published = self.misp_published
 
-    def __init__(
-        self,
-        config: Config,
-        misp_url: str,
-        misp_key: str,
-        misp_verifycert: bool = True,
-        mwdb_url: str = None,
-    ) -> None:
-        """
-        Create instance of the MispPusher.
-
-        :param config: Karton configuration object
-        :param misp_url: URL of the paired MISP instance
-        :param misp_key: API key of the paired MISP instance
-        :param misp_verifycert: "False" to skip TLS cert validation (unrecommended)
-        :param mwdb_url: Optional mwdb url, for `link` MISP attribute
-        """
-
-        super().__init__(config)
-
-        self.misp_url = misp_url
-        self.misp_key = misp_key
-        self.misp_verifycert = misp_verifycert
-        self.mwdb_url = mwdb_url
+        misp.add_event(event)
 
     @classmethod
-    def args_parser(cls):
-        def http_url(value):
-            """Ensure that provided value looks like a HTTP URL (https://sth),
-            and strip a trailing slash. The goal is to avoid confusion between
-            "url.com", "http://url.com", "http://url.com/", etc.
-            """
-            if not value.startswith("http"):
-                raise ValueError("URL should start with http[s]://")
-            return value.rstrip("/")
-
+    def args_parser(cls) -> argparse.ArgumentParser:
         parser = super().args_parser()
         parser.add_argument(
             "--misp-url",
-            type=http_url,
-            required=True,
             help="URL of the paired MISP instance",
         )
         parser.add_argument(
             "--misp-key",
-            required=True,
             help="API key of the paired MISP instance",
         )
         parser.add_argument(
+            "--misp-published",
+            action="store_true",
+            help="Publish MISP Events",
+            default=None,
+        )
+        parser.add_argument(
+            "--misp-tag-events",
+            help="Tag MISP events with mwdb family names",
+            action=argparse.BooleanOptionalAction,
+            default=None,
+        )
+        parser.add_argument(
             "--misp-insecure",
             help="Skip MISP certificate verification",
             action="store_true",
+            default=None,
         )
         parser.add_argument(
             "--mwdb-url",
             type=http_url,
             help="Optional mwdb url, for `link` MISP attributes",
         )
+        parser.add_argument(
+            "--galaxy-clusters-mapping",
+            help="Link config family names to galaxy clusters using the file",
+        )
         return parser
 
     @classmethod
-    def main(cls):
-        parser = cls.args_parser()
-        args = parser.parse_args()
-
-        config = Config(args.config_file)
-        service = cls(
-            config, args.misp_url, args.misp_key, not args.misp_insecure, args.mwdb_url
+    def config_from_args(cls, config: Config, args: argparse.Namespace) -> None:
+        super().config_from_args(config, args)
+        config.load_from_dict(
+            {
+                "misp": {
+                    "url": args.misp_url,
+                    "key": args.misp_key,
+                    "published": args.misp_published,
+                    "tag_events": args.misp_tag_events,
+                    "insecure": args.misp_insecure,
+                    "mwdb_url": args.mwdb_url,
+                    "galaxy_clusters_mapping": args.galaxy_clusters_mapping,
+                }
+            }
         )
-        service.loop()
```

## Comparing `karton_misp_pusher-1.0.0-nspkg.pth` & `karton_misp_pusher-1.1.0-nspkg.pth`

 * *Files identical despite different names*

## Comparing `karton_misp_pusher-1.0.0.dist-info/LICENSE` & `karton_misp_pusher-1.1.0.dist-info/LICENSE`

 * *Files identical despite different names*

